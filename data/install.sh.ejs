#!/bin/bash
set -u
printf '\e[8;50;120t'

echo '‚è≥ Checking if Homebrew is installed ...'
which -s brew
if [[ $? != 0 ]]; then
    echo '‚è≥ Installing Homebrew ...'
    /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
fi
echo '‚úÖ Homebrew is installed'

echo '‚è≥ Installing prerequisites ...'
brew install jq figlet
echo '‚úÖ Prerequisites are installed'

figlet -f slant -c 'Brew My Mac'

<% if (items.some(item => item.source === 'Homebrew')) { %>
echo '‚è≥ Installing Homebrew packages ...'
  <% items.forEach(function(item) { %>
    <% if (item.source === 'Homebrew') { %>
brew install <%= item.id %>
if [[ $? != 0 ]]; then
    echo '‚ùå Failed to install <%= item.name %> from Homebrew'
else
    echo '‚úÖ Successfully installed <%= item.name %> from Homebrew'
fi
    <% } %>
  <% }) %>
<% } %>

<% if (items.some(function(item) { return item.source === 'Homebrew-Cask'; })) { %>
echo '‚è≥ Installing Homebrew Cask packages ...'
  <% items.forEach(function(item) { %>
    <% if (item.source === 'Homebrew-Cask') { %>
brew install <%= item.id %>
if [[ $? != 0 ]]; then
    echo '‚ùå Failed to install <%= item.name %> from Homebrew-Cask'
else
    echo '‚úÖ Successfully installed <%= item.name %> from Homebrew-Cask'
fi
    <% } %>
  <% }) %>
<% } %>

<% if (items.some(function(item) { return item.source === 'App Store'; })) { %>
echo -n "‚ùì Press Command+C to quit now if you have not already signed in to App Store. Otherwise, press any key to continue "
for _ in { 1.. 10 }; do read -rs -n1 -t1 || printf "."; done

echo '‚è≥ Installing App Store apps ...'
  <% items.forEach(function(item) { %>
    <% if (item.source === 'App Store') { %>
mas install <%= item.id %>
if [[ $? != 0 ]]; then
    echo '‚ùå Failed to install <%= item.name %> from App Store'
else
    echo '‚úÖ Successfully installed <%= item.name %> from App Store'
fi
    <% } %>
  <% }) %>
<% } %>

<% if (items.some(function(item) { return item.source === 'Tweak'; })) { %>
echo '‚è≥ Checking if Ansible is installed ...'
which -s ansible
if [[ $? != 0 ]]; then
    echo '‚è≥ Installing Ansible ...'
    brew install ansible
fi
echo '‚úÖ Ansible is installed'

echo 'üåé Downloading Ansible playbook ...'
curl -s -o /tmp/playbook.yml https://raw.githubusercontent.com/ayltai/ansible-macos-tweaks/master/playbook.yml

echo 'üëâ Applying tweaks. You may be prompted for your root password.'
echo '‚è≥ Running Ansible playbook ...'
ansible-playbook /tmp/playbook.yml --extra-vars "<%= items.map(item => item.parameter === undefined ? `${item.id}_enabled=true` : `${item.id}_enabled=true ${item.id}_value=${item.parameter}`).join(' '); %>"
if [[ $? != 0 ]]; then
    echo '‚ùå Failed to apply one or more tweaks'
else
    echo '‚úÖ Successfully applied <%= items.length %> tweak<%= items.length === 1 ? '' : 's' %>'
fi
rm /tmp/playbook.yml
<% } %>

echo 'üëâ BrewMyMac has finished.'
figlet -f banner3-d 'Enjoy!'
